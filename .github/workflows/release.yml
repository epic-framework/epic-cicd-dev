name: Release

on:
  workflow_dispatch:
    inputs:
      update_type:
        description: "Version bump type"
        required: true
        default: "patch"
        type: choice
        options:
          - patch
          - minor
          - major
      pypi_target:
        description: "PyPI target"
        required: true
        default: "Test PyPI"  # TODO:! change to production in a real job
        type: choice
        options:
          - "PyPI Prod"
          - "Test PyPI"

jobs:
  kickoff:
    runs-on: ubuntu-latest
    steps:
      - name: Notify Slack (release started)
        uses: epic-framework/.github/.github/actions/notify-slack@main
        with:
          message_type: release-start
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL__RELEASE }}
          version_bump: ${{ github.event.inputs.update_type }}
          pypi_target: ${{ github.event.inputs.pypi_target }}

  test:
    needs: kickoff
    uses: ./.github/workflows/_test.yml

  bump_and_build:
    needs: test
    # note: we still need "production" here, for the GH_PAT secret; at least it has no permission to use an OIDC token
    environment: production
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.bump_and_build.outputs.new_version }}
    steps:
    - name: Run bump-and-build
      id: bump_and_build
      uses: epic-framework/.github/.github/actions/bump-and-build@main
      with:
        update_type: ${{ github.event.inputs.update_type }}
        access_token: ${{ secrets.GH_PAT }}

  publish:
    needs: bump_and_build
    environment: production
    permissions:
      id-token: write
      contents: read
    runs-on: ubuntu-latest
    steps:
      - name: Publish to PyPI
        uses: epic-framework/.github/.github/actions/publish-pypi@main
        with:
          pypi_target: ${{ github.event.inputs.pypi_target }}
          version: ${{ needs.bump_and_build.outputs.version }}
          slack_webhook_url: ${{ secrets.SLACK_WEBHOOK_URL__RELEASE }}

  notify_failure:
    needs: [test, bump_and_build, publish]
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Notify Slack (failure)
        uses: epic-framework/.github/.github/actions/notify-slack@main
        with:
          message_type: release-error
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL__RELEASE }}
          pypi_target: ${{ github.event.inputs.pypi_target }}
